#summary Story outlining an implementation of the Forms WG simplified syntax for XForms suitable for HTML4 forms authors
#labels Story,SimplifiedSyntax

= Introduction =

As part of the Forms WG, a simplified syntax for XForms has been proposed along with a mapping onto the equivalent "canonical" XForms notation.  This syntax is summarized in [http://lists.w3.org/Archives/Public/public-forms/2008Mar/0097.html].  

This story is where we can explore an approach to implementing the simplified syntax in Ubiquity XForms in order to further refine the notation and to be able to show running example forms to other interested parties...


= Details =

The link above presents a sample form for purchase line items and their totals as follows:

{{{
<repeat name="row"> 
    <select1 name="Product"> ... 
    <input name="Price" type="decimal" default="0.00"> ... 
    <input name="Quantity" type="integer" default="0"> ... 
    <output name="LineTotal" calculate="Price * Quantity"/> 
</repeat> 

<output name="Subtotal" calculate="sum(row/LineTotal)"/> 
<output name="Tax" calculate="Subtotal * 0.07"/> 
<output name="Total" calculate="Subtotal + Tax"/> 

}}}

There are many details that result from this notation which are explored at the linked page from the W3C Forms email archive.  This wiki page serves to itemize the resulting Features for the XForms Ubiquity project and to suggest a priority order for implementing them.

The above form fragment should be equivalent to the following canonical XForms markup:

{{{
<model> 
  <instance id="default"> 
    <data xmlns=""> 
      <row> 
         <Product>... 
         <Price>... 
         <Quantity>... 
         <LineTotal>... 
      </row> 
      <row> 
         <Product>... 
         <Price>... 
         <Quantity>... 
         <LineTotal>... 
      </row> 
      <Subtotal>... 
      <Tax>... 
      <LineTotal>... 
    </data> 
  </instance> 

  <instance id="row_template"> 
      <row xmlns=""> 
         <Product></Product> 
         <Price>0.00</Price> 
         <Quantity>0</Quantity> 
         <LineTotal></LineTotal> 
      </row> 
  </instance> 
 
  <bind id="row" nodeset="row"> 
    <bind id="Product" nodeset="Product"/> 
    <bind id="Price" nodeset="Price" type="decimal"/> 
    <bind id="Quantity" nodeset="Quantity" type="integer"/> 
    <bind id="LineTotal" nodeset="LineTotal">
       <calculate context=".." value="Price * Quantity" or "$Price * 
$Quantity"/> 
    </bind>
  </bind> 
  <bind id="Subtotal" nodeset="Subtotal">
     <calculate context=".." value="sum(row/LineTotal)" or 
"sum($LineTotal)"/> 
  </bind>
  <bind id="Tax" nodeset="Tax">
     <calculate context=".." value="Subtotal * 0.07" or "$Subtotal * 
0.07"/> 
  </bind>
  <bind id="Total" nodeset="Total">
     <calculate context=".." value="Subtotal + Tax" or "$Subtotal + 
$Tax"/> 
  </bind>
</model>

<repeat bind="row"> 
    <select1 bind="Product"> ... 
    <input bind="Price"> ... 
    <input bind="Quantity"> ... 
    <output bind="LineTotal"/> 
</repeat>
<output bind="Subtotal"/>
<output bind="Tax"/> 
<output bind="Total"/> 

<trigger>
    <label>...</label>
    <insert ev:event="DOMActivate" context="." bind="row" 
at="index('row')" position="after" origin="instance('row_template')"/>
</trigger>
<trigger>
   <label>...</label>
   <delete bind="row" at="index('row')"/>
</trigger>

}}}

We can derive the following Features from this mapping:

===FeatureSimplifiedGenerateInstances===

The `name` attributes, and their nesting, imply the element names and hierarchy for an associated canonical XForms instance.  Note that the generated instance need not in general be flat in that `name`'s may be nested in groups and/or on repeats and their child elements (other repeats or controls).

Another interesting aspect of this Feature, is that row insertion in XForms 1.1 uses a separate instance to contain the template for new rows (unlike XForms 1.0 where row insertion used a row internal to the list as template).  This Feature therefore also needs to generate these insertion templates for repeats in the input simplified markup.

===FeatureSimplifiedGenerateBinds===

Binds too are implied by the occurance of `name`s in the simplified markup and have important characteristics in terms of the evaluation context for any calculate expressions that may occur on the UI markup.  See the link above for detailed discussion in the Forms WG email archives for the generation of appropriate context attributes and nesting rules for implied binds.

===FeatureSimplifiedGenerateVariables===

XPath variables are implied as an additional mechanism for surfacing the calculation results of binds for use in calculate expressions in the simplified syntax.  This feature is probably of lower priority for initial implementation as the element names of the implied instance data can be used directly as shown in the example form above.

===FeatureSimplifiedInsertDeleteRows===

Some design work may still be required to nail down the IDL for row insert/delete and its use from HTML4 style event handlers...let's discuss directly on the Feature wiki page when we get here...

===FeatureSimplifiedSubmission===

Some proposals for submission and related discussion are given in [http://lists.w3.org/Archives/Public/public-forms/2008Apr/0063.html]

===FeatureSimplifiedFormElement===

Discussion of the form element in the XForms simplified syntax is at: [http://lists.w3.org/Archives/Public/public-forms/2008Apr/0064.html]


== Loan Form Example ==

The following form shown the simplified syntax of the Loan Form example from John.

The original sample form can be found at 
[http://ubiquity-xforms.googlecode.com/svn/branches/loan-form/_samples/Loan/loan-lowercase.html]

{{{

<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <script>g_sBehaviourDirectory = "../../behaviours/";g_temporaryFlagLoadCustomControls=true;</script>
   <script src="../../ubiquity-simple.js" ></script>
   <script src="../../ubiquity-loader.js" type="text/javascript">/**/</script>
</head>
<body>

<form impl="xforms-simple"
      name="datarecord" 
      action="http://xformstest.org/cgi-bin/echo.sh" 
      method="post" >
   <label>Loan Form</label>
   <label for="startdate" >Agreement Date:</label>
   <input name="startdate" type="date" default="08/08/2008" />
   <br/>
   <group name="borrower">
     <label>Borrower</label>
     <label for="name">Name:</label>
     <input id="name" name="name" type="string" default="Joe Q. Public" />
     <br/>
     <label for="addr">Address:</label>
     <input id="addr" name="addr" type="string" default="123 Main St. Tinyville" />
     <br/>     
   </group>
   <label for="principal">Principal</label>
   <input name="principal" type="double" default="10000" />
   <br/>
   <label for="currency">Choose currency</label>
   <select name="currency" >
     <option value="USD">US Dollars</option>
     <option value="CDN">Canadian Dollars</option>
     <option value="EUR">Euros</option>
   </select>
   <br/>
   <label for="duration">Duration of Loan in Months:</label>
   <input name="duration" type="integer" default="12" />
   <label for="interestrate">Yearly Interest Rate:</label>
   <input name="interestrate" type="double" default="5" />
   <br/>
   <label for="submit">Apply Loan</label>
   <submit id="submit" />
</form>
</body>
</html>

}}}

There are a few tentative decisions I have assumed in the proccess on converting the orginal form to the above simplified syntax:

  # The elements of the simplified syntax is assumed to be in the HTML namespace tentatively.
  # Since the form is assumed to be in an HTML namespace, there should be a way to separate/switch the simplified syntax from a regular HTML's form. Since namespace seems to be a non-starter. An _impl_ attribute is tentatively added to indicate the content of the form is implemented using xforms's simplified syntax. 
  {{{
   <form impl="xforms-simple"... >
   ..
   </form>
  }}}
  # In the original loan form example, the data instance has a structure that doesn't involve a repeat (such as the one in the summarized example). A _group_ element is added to capture the same data structure of a  structured data instance.
{{{
   <!-- sturcture data instance using simplified syntax -->
   <group name="borrower">
     <input id="name" name="name" type="string" default="Joe Q. Public" />
     ...
     <input id="addr" name="addr" type="string" default="123 Main St. Tinyville" />
     ...
   </group>

   <!-- data structure in data instance -->
   <borrower>
     <name>John Q. Public</name>
     <addr>123 Main St. Tinyville</addr>
   </borrower>   
}}}
  # In the Simplified Syntax Proposal, there is no dicussion of where to obtain or how to specific the xforms's label in the syntax. Most of the time in HTML, label is just a brunch of text nodes in front of the HTML input field. 
  In above loan form example, the HTML label/for syntax is used as to define an input's label. A _label_ element is specified with inline text and a _for_ attribute is referenced to input element's id; Also notice a label element can be hanged as a child element of a container (form/group) which indicate that the label is for the corresponding group/form.
  {{{
  <group name="borrower">
    <label>Borrower</label>
    <label for="name">Name:</label>
    <input id="name" name="name" type="string" default="Joe Q. Public" />
    ....
  </group>
  }}}
  The syntax is a tentative decision to cater more to the existing HTML syntax. I would imagine others might has differnt opinion on that. Some has suggested we could simpify it by adding a _label_ attribute on the input or putting the label as inline text of an input.
  {{{
    <!-- inline text -->
    <input id="name" name="name" type="string" default="Joe Q. Public">Name</input>
    <!-- label attribute -->
    <input id="name" name="name" label="Name" type="string" default="Joe Q. Public"/>
  }}}