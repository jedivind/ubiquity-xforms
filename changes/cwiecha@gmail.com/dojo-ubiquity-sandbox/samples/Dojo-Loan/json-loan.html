<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ev="http://www.w3.org/2001/xml-events" 
      xmlns:xforms="http://www.w3.org/2002/xforms" 
      xmlns:xsd="http://www.w3.org/2001/XMLSchema"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-Instance"
	  xmlns:javascript="http://www.w3.org/2002/xforms#inline">
 <head>
    <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"></meta>
    <title>XForms Loan Application Form</title>  
    <link rel="stylesheet" type="text/css" href="file:///Users/wiecha/Documents/Windows/UbiquityWorkspace/Dojo/dojo-release-1.4.0/dijit/themes/tundra/tundra.css">     
    <script src="../../src/ubiquity-loader.js" type="text/javascript">/**/</script>
	<script src="format.js" type="text/javascript">/**/</script>
    <script type="text/javascript" src="file:///Users/wiecha/Documents/Windows/UbiquityWorkspace/Dojo-src/dojo-release-1.4.0-src/dojo/dojo.js"
        djConfig="parseOnLoad: false"></script>
        
    <link type="text/css" href="style/gen_default.css" rel="stylesheet"></link>

 </head>
    
    <body class="tundra" onload="setupDojoStartupListener()">
        <script type="text/javascript">
            dojo.require("dijit.layout.ContentPane");
            dojo.require("dijit.layout.AccordionContainer");
            dojo.require("dojo.parser");  // find widgets
            
            function doDojo() {
                dojo.parser.parse();
            }
            
            function setupDojoStartupListener() {
                var model = document.getElementById( "loan_model" );
                model.addEventListener( "xforms-ready", doDojo, false );
            }
        </script>
        
    <script id="loan_init" type="application/json">
        {
        "LoanRecord" : { 
            "Currencies" : {
                "Currency" : ["USD", "CDN", "Euro"]
            },
            "StartDate" : "2008-08-08", 
            "Borrower" : { 
                "Name" : "John Q. Public", 
                "Addr" : "123 Main St Tinyville" 
                },             
             "Principal" : "1000",
             "Duration" : "12",
             "InterestRate" : "5",
             "Monthly-Payment" : "0",
             "TotalPayout" : "0"
          }
        }
    </script>
      
    <script id="geo_init" type="application/json">
        {
            "GeoQuery" : {
                "postalcode" : "10706",
                "country"    : "US"
            }
        }
    </script>

    <xforms:model id="loan_model">
        <xforms:instance id="loan" src="#loan_init"></xforms:instance>
        
        <xforms:instance id="geo_query" src="#geo_init"></xforms:instance>
        
        <xforms:instance id="rate">
	        <rate  xmlns=""></rate>
        </xforms:instance>
    
        <xforms:submission id="doQuery" 
            ref="instance('geo_query')"
            method="get"
            replace="instance"
            instance="geo_query"
            includenamespaceprefixes=""
            serialization="application/json"
            action="http://ws.geonames.org/postalCodeLookupJSON">
            <xforms:message ev:event="xforms-submit-error" level="modal">Unable to submit</xforms:message>
        </xforms:submission>
        
        
        <xforms:submission id="makeLoan" 
            ref="instance('loan')"
            method="post"
            replace="all"                           
            includenamespaceprefixes=""
            serialization="application/json"
            action="http://xformstest.org/cgi-bin/echo.sh">
            <xforms:message ev:event="xforms-submit-error" level="modal">Unable to submit</xforms:message>
        </xforms:submission>

        <xforms:bind nodeset="instance('loan')/currencies/currency[@att = 'calc']" calculate="concat(../currency[1], ' or ', ../currency[2])"></xforms:bind>
        
        <xforms:instance id="rate">
            <rate  xmlns=""></rate>
        </xforms:instance>
        
        <xforms:bind nodeset="instance('rate')" 
            calculate="instance('loan')/InterestRate div 1200.0"></xforms:bind>
        
        <xforms:bind nodeset="TotalPayout" 
            calculate="../Monthly-Payment * ../Duration" 
            relevant="../Monthly-Payment &gt; 0 and ../Duration &gt; 0"></xforms:bind>
        
        <xforms:bind nodeset="Monthly-Payment" 
            calculate="if(instance('rate') &gt; 0, 
            ../Principal * instance('rate') div (1.0 - power(1.0 + instance('rate'), -../Duration)),
            ../Principal div ../Duration)"
            relevant="../Principal > 0 and ../Duration > 0"></xforms:bind>
        
        <xforms:bind nodeset="Borrower/Name" required="true()" constraint="string-length(.) > 0"></xforms:bind>
        <xforms:bind nodeset="Borrower/Addr" required="true()" constraint="string-length(.) > 0"></xforms:bind>
        
        <xforms:bind nodeset="Principal"
            type="xsd:double" 
            constraint=". &gt;= 1000 and . &lt;= 100000"></xforms:bind>
        
        <xforms:bind nodeset="Duration" 
            type="xsd:positiveInteger"
            constraint=". &lt;= 84"></xforms:bind>
        
        <xforms:bind nodeset="InterestRate"
            type="xsd:double" 
            constraint=". &gt;= 5 and . &lt;= 60"></xforms:bind>
        
        <xforms:bind nodeset="StartDate" type="xsd:date"></xforms:bind>
        
        <xforms:setvalue ev:event="xforms-ready" 
            ref="StartDate" 
            value="choose(.='',substring(local-date(),1,10),.)"></xforms:setvalue>   

    </xforms:model>
 
      <xforms:label class="company_name">Big Red Loan and Mortgage Co.</xforms:label>
      
      <xforms:label class="company_motto">The name to trust when you're... in the red.</xforms:label>
        
      <br/>
      <br/>
      
<xforms:group ref="instance('loan')">
      
      <xforms:input ref="/LoanRecord/StartDate" datatype="xforms:date"> 
          <xforms:label>Agreement Date: </xforms:label>
      </xforms:input> 
      
 
      
      <xforms:input class="red" ref="Borrower/Name">
          <xforms:label>Borrower Name:</xforms:label>
          <xforms:hint>Get the name of the person that's going to receive the money.</xforms:hint>
      </xforms:input>
      

      
      <xforms:input ref="Borrower/Addr">
          <xforms:label>Borrower's Address:</xforms:label> 
          <xforms:hint>You need to know where the borrower lives so you can visit him if needed.</xforms:hint>
      </xforms:input>
      
 
      
      <xforms:input ref="Principal">
          <xforms:label>Principal of Loan:</xforms:label>
          <xforms:hint>Enter the amount of money you will give the borrower.</xforms:hint>
          <xforms:alert>The dollar value must be between 1000 and 100000</xforms:alert>
      </xforms:input>
      
     
      <xforms:select1 ref="Principal/@currency" appearance="minimal" incremental="true">
          <xforms:label>Choose currency</xforms:label> 
          <xforms:item>
              <xforms:label>US Dollars</xforms:label>
              <xforms:value>USD</xforms:value>
          </xforms:item>
          <xforms:item>
              <xforms:label>Canadian Dollars</xforms:label>
              <xforms:value>CDN</xforms:value>
          </xforms:item>
          <xforms:item>
              <xforms:label>Euros</xforms:label>
              <xforms:value>EUR</xforms:value>
          </xforms:item>
      </xforms:select1>
      

     
      <xforms:input ref="Duration">
          <xforms:label>Duration of Loan in Months:</xforms:label>
          <xforms:hint>Don't give out ol' Big Red's money for longer than seven years!</xforms:hint>
          <xforms:alert>Range is 1 to 84</xforms:alert>
      </xforms:input>
      
  
 
      
      <xforms:input ref="InterestRate" incremental="true">
          <xforms:label>Yearly Interest Rate (compounded monthly):</xforms:label>
          <xforms:hint>We're only loan dogfish, so no more than sixty percent.</xforms:hint>
          <xforms:alert>Choose an interest rate between 5 and 60 percent.</xforms:alert>
      </xforms:input>
      

      
      <xforms:input class="regular" ref="Monthly-Payment">
          <xforms:label>Monthly Payment: </xforms:label>
      </xforms:input>
      
  
      
      <xforms:input class="regular" ref="TotalPayout">
          <xforms:label>Total Payout: </xforms:label>
      </xforms:input>

</xforms:group>
      
      <!-- This submit button results in activating the makeLoan submission -->
      <xforms:submit submission="makeLoan">
          <xforms:label>Submit Loan</xforms:label>
          <xforms:hint>Sends the loan transaction to Big Red</xforms:hint>          
      </xforms:submit>
      
      <hr size="6" class="rule"></hr>
        <br/>
        <br/>
        
<xforms:group>
      
      <xforms:input ref="instance('geo_query')/postalcode">
          <xforms:label>Postal code:</xforms:label> 
      </xforms:input>
      
            
      <xforms:input ref="instance('geo_query')/country">
          <xforms:label>Country:</xforms:label>          
      </xforms:input>
      
            
      <xforms:input class="red" ref="instance('geo_query')/adminName2">
          <xforms:label>Admin name 2:</xforms:label>
          <xforms:hint>Get the name of the person that's going to receive the money.</xforms:hint>
      </xforms:input>
      
      
      
      <xforms:input ref="instance('geo_query')/placeName">
          <xforms:label>Place name:</xforms:label>
      </xforms:input>
      
      
</xforms:group>    
      
      <!-- This submit button results in activating the geo query submission -->
      <xforms:submit submission="doQuery">
          <xforms:label>Submit Query</xforms:label>
          <xforms:hint>Sends the Geo Query</xforms:hint>          
      </xforms:submit>
      
      <div class="spacer"></div><hr size="6" class="rule"></hr>
      

  </body>

</html>
