<!--
  // Ubiquity provides a standards-based suite of browser enhancements for
  // building a new generation of internet-related applications.
  //
  // The Ubiquity XForms module adds XForms 1.1 support to the Ubiquity
  // library.
  //
  // Copyright (C) 2008 Backplane Ltd.
  //
  // Licensed under the Apache License, Version 2.0 (the "License");
  // you may not use this file except in compliance with the License.
  // You may obtain a copy of the License at
  //
  //  http://www.apache.org/licenses/LICENSE-2.0
  //
  // Unless required by applicable law or agreed to in writing, software
  // distributed under the License is distributed on an "AS IS" BASIS,
  // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  // See the License for the specific language governing permissions and
  // limitations under the License.
-->
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xf="http://www.w3.org/2002/xforms" >
<head>
<title>Search Flickr using XForms Data Model and Dojo ThumbnailPicker</title>  
  
<!-- required: a default theme file -->
<link rel="stylesheet" id="themeStyles" href="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dijit/themes/tundra/tundra.css" />
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dojox/image/resources/image.css" />
  
<style type="text/css">
  @import "http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dijit/tests/css/dijitTests.css";
</style>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/utilities/utilities.js">/**/</script>
<script type="text/javascript">
djConfig={
        parseOnLoad:true,
        isDebug:true,
        modulePaths: {
           'dijit': 'http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dijit',
           'dojox' :  'http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dojox'
        }
    }
</script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dojo/dojo.js" >/**/</script>
<!-- do not use! only for testing dynamic themes -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dijit/tests/_testCommon.js"></script>
<!-- for debugging: -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dojox/image/ThumbnailPicker.js"></script>

<script src="../../src/ubiquity-loader.js" type="text/javascript">/**/</script>
<script type="text/javascript" src="js/ubModelData.js">/**/</script>

<script type="text/javascript" >
dojo.require("dijit.form.TextBox");
dojo.require("dijit.form.Button");
dojo.require("dojo.parser");  // find widgets

var flickrModelStore = null;

// This is the onload handler, 
// call to initialize Model Store
function initModelStoreWidget() {	
   console.log("initItemStorage");

   var modelArgs = {
	   id: "flickrModel",    // XForms Model id
		submissionId: "sub-flickr", // XForms submission id
		submitDone: {  // XForms listener for submission done
		   handleEvent: function(evt) { console.log("xforms submit successful!"); }
      }, 
      submitError: { // XForms listener for submission error
         handleEvent: function(evt) { console.log("xforms submit error"); }
      },
      // Customize attributes
      itemXPathAttrs : { 
         imageUrlThumb: "concat('http://static.flickr.com/', @server, '/', @id, '_', @secret, '_t.jpg')",
    	   imageUrl: "concat('http://static.flickr.com/', @server, '/', @id, '_', @secret, '_m.jpg')",
    	   link: "concat('http://www.flickr.com/photos/', @owner, '/', @id)" 
	   }
	};

	// Create the XForms data model
   flickrModelStore = new UBXFx.data.ModelData(modelArgs);
   dojo.connect(flickrModelStore, "onSet", updateWidgetStore);
}


function updateWidgetStore(item, attribute, oldValue, newValue) {
   console.log("update store");
	var request = {
	   // Query  to indicate which items to return
		query: { result: "instance('inst-rs')/photos/photo" },
		start: 0, //start at record 0
		pageSize: 50 //request 50 records each time a request is made
   };

	// This fetchs the items into the data store (it callls xform submit)
	dijit.byId('thumbPicker1').setDataStore(flickrModelStore, request, null);
	dijit.byId('thumbPicker2').setDataStore(flickrModelStore, request, null);
}


// This is the method called when search Flickr is clicked
function getImages() {
   if (!flickrModelStore) {
	   alert("Error: flickrModel not created.... try refresh the browser.");
		return;
   }

   var tagsValue = dijit.byId("searchTag").getDisplayedValue();

   // Get the tags item element and set it to the new tags value
   var item = flickrModelStore.getModelItem("instance('i1')/tags");
   flickrModelStore.setValue(item, "nodeValue", tagsValue);	
}

// Add onload listener
dojo.addOnLoad(initModelStoreWidget);

</script>
</head>
<body>
<!--   The XForms Model
       Defining the data for the form, and the submission handling
-->
<xf:model id="flickrModel" >
  <!-- The data sent to flickr -->
  <xf:instance id="i1">
    <instanceData xmlns="">
      <method>flickr.photos.search</method>
        <api_key>68149024a667e0be3c63708f002ffe1e</api_key>
        <tags/>
        <per_page>50</per_page>
      </instanceData>
  </xf:instance>
  <!-- The data received by flickr -->
  <xf:instance id="inst-rs" xmlns="">
    <dummy/>
  </xf:instance>
  <xf:submission id="sub-flickr" method="get" 
      action="http://www.flickr.com/services/rest/"
      separator="&amp;" replace="instance" instance="inst-rs">
  </xf:submission>
</xf:model>

  <h2>Search Fickr From XForms ModelStore:</h2>
  <!--  Dojo UI -->
  <input  id="searchTag" dojoType="dijit.form.TextBox" type=text name="tag" trim="true" propercase="false">
  <button id="getBtn"  dojoType="dijit.form.Button" onClick="getImages()">Search Flickr</button>
  
  <h3>ThumbnailPicker 1</h3>
  This ThumbnailPicker should have 4 thumbnails, with each of them linking
  to a URL when clicked on, changing the current page.  The cursor should also change when over an image.
  The widget is laid out in the default horizontal layout.
  <div id="thumbPicker1" dojoType="dojox.image.ThumbnailPicker" numberThumbs="4" isClickable="true" useHyperlink="new" ></div>

  <h3>ThumbnailPicker 2</h3>
  This ThumbnailPicker should have 4 thumbnails. Clicking on a thumbnail should NOT
  open a URL, and the cursor should not change when over an image that is not an arrow.
  <div id="thumbPicker2" dojoType="dojox.image.ThumbnailPicker"  numberThumbs="4" isClickable="false"></div>
</body>
</html>