<!--
  * Copyright (C) 2008 Backplane Ltd.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
  *
  *  http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
-->
<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:xf="http://www.w3.org/2002/xforms"
	xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xs="http://www.w3.org/2001/XMLSchema"
>
	<head>
		<title>Insert action: Inserting attributes</title>
		<script type="text/javascript" src="../../../../src/ubiquity-loader.js" >/**/</script>
		<link rel="stylesheet" href="../style/sample.css" type="text/css" />
		<style type="text/css">
			xf\:output { display: block; }
		</style>
	</head>
	<body>
		<xf:model id="mdl">
			<xf:instance>
				<instanceData xmlns="" attr="ok" status="not started">
					<t1 dummy="failed" attr="failed" ></t1>
					<t2 dummy="failed" attr="failed" ></t2>
					<t4 ></t4>
					<t5 dummy="failed" ></t5>
					<t6 ></t6>
					<t7 ></t7>
				</instanceData>
			</xf:instance>

			<!--
				Two ways to overwrite the value of an attribute. Both actually
				delete the node then insert it again, but the position will be
				different:

					* for test 1 the 'recreated' attribute will be
					  second, since it will be after the old node;

					* for test 2 the attribute will be placed first,
					  since the nodeset is the node itself, so there
					  is a 'mismatch' between the nodeset and the
					  node to be inserted, causing insertion at the
					  start.

				These two conditions are tested in tests 3 and 4.
			-->
			<xf:action ev:event="test-1">
				<xf:insert nodeset="t1/@attr" origin="@attr" ></xf:insert>
				<xf:dispatch target="mdl" name="test-1-complete" ></xf:dispatch>
			</xf:action>

			<xf:action ev:event="test-2">
				<xf:insert nodeset="t2" origin="@attr" ></xf:insert>
				<xf:dispatch target="mdl" name="test-2-complete" ></xf:dispatch>
			</xf:action>

			<!--
				Create a new attribute. We need to test that this
				can be done when the element has no attributes,
				and some attributes.
			-->
			<xf:action ev:event="test-5">
				<xf:insert nodeset="t5" origin="@attr" ></xf:insert>
				<xf:dispatch target="mdl" name="test-5-complete" ></xf:dispatch>
			</xf:action>

			<xf:action ev:event="test-6">
				<xf:insert nodeset="t6" origin="@attr" ></xf:insert>
				<xf:dispatch target="mdl" name="test-6-complete" ></xf:dispatch>
			</xf:action>

			<!--
				If the nodeset is empty, use the context.
			-->
			<xf:action ev:event="test-7">
				<xf:insert nodeset="i-dont-exist" context="t7" origin="../@attr" ></xf:insert>
				<xf:dispatch target="mdl" name="test-7-complete" ></xf:dispatch>
			</xf:action>

			<!--
				Indicate that we're done.
			-->
			<xf:action ev:event="tests-complete">
				<xf:setvalue ref="@status">complete</xf:setvalue>
			</xf:action>
			
			<!--
				Chain the tests together. We do this because we might at
				some point want to allow each test to be run from a trigger,
				or one test might use the results of a prior test.
			-->
			<xf:dispatch target="mdl" name="test-1" ev:event="xforms-ready" ></xf:dispatch>
			<xf:dispatch target="mdl" name="test-2" ev:event="test-1-complete" ></xf:dispatch>
			<xf:dispatch target="mdl" name="test-5" ev:event="test-2-complete" ></xf:dispatch>
			<xf:dispatch target="mdl" name="test-6" ev:event="test-5-complete" ></xf:dispatch>
			<xf:dispatch target="mdl" name="test-7" ev:event="test-6-complete" ></xf:dispatch>
			<xf:dispatch target="mdl" name="tests-complete" ev:event="test-7-complete" ></xf:dispatch>
		</xf:model>
		<xf:output id="t1" ref="t1/@attr">
			<xf:label>Test 1:</xf:label>
		</xf:output>
		<xf:output id="t2" ref="t2/@attr">
			<xf:label>Test 2:</xf:label>
		</xf:output>
		<!--
			This is disabled pending decision by the XForms Working Group. The issue
			is that it is not actually possible to guarantee that an attribute is in
			a particular position.
		-->
		<!-- xf:output id="t3" ref="t1/@*[2]">
			<xf:label>Test 3:</xf:label>
		</xf:output>
		<xf:output id="t4" ref="t2/@*[1]">
			<xf:label>Test 4:</xf:label>
		</xf:output -->
		<xf:output id="t5" ref="t5/@attr">
			<xf:label>Test 5:</xf:label>
		</xf:output>
		<xf:output id="t6" ref="t6/@attr">
			<xf:label>Test 6:</xf:label>
		</xf:output>
		<xf:output id="t7" ref="t7/@attr">
			<xf:label>Test 7:</xf:label>
		</xf:output>
		<xf:output id="status" ref="@status">
			<xf:label>Status:</xf:label>
		</xf:output>
	</body>
</html>
