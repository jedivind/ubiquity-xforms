<!--
  // Ubiquity provides a standards-based suite of browser enhancements for
  // building a new generation of internet-related applications.
  //
  // The Ubiquity XForms module adds XForms 1.1 support to the Ubiquity
  // library.
  //
  // Copyright (C) 2008 Backplane Ltd.
  //
  // Licensed under the Apache License, Version 2.0 (the "License");
  // you may not use this file except in compliance with the License.
  // You may obtain a copy of the License at
  //
  //  http://www.apache.org/licenses/LICENSE-2.0
  //
  // Unless required by applicable law or agreed to in writing, software
  // distributed under the License is distributed on an "AS IS" BASIS,
  // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  // See the License for the specific language governing permissions and
  // limitations under the License.
-->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xf="http://www.w3.org/2002/xforms">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>PicasaWeb Image Search powered by XForms Data Source</title>

<!--  DOJO declarations -->

<!-- required: a default theme file -->
<link rel="stylesheet" id="themeStyles" href="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dijit/themes/tundra/tundra.css" />
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dojox/image/resources/image.css" />
  
<style type="text/css">
  @import "http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dijit/tests/css/dijitTests.css";
</style>

<script type="text/javascript">
djConfig={
        parseOnLoad:true,
        isDebug:true,
        modulePaths: {
           'dijit': 'http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dijit',
           'dojox' :  'http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dojox'
        }
    }
</script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dojo/dojo.js" >/**/</script>
<!-- do not use! only for testing dynamic themes -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dijit/tests/_testCommon.js"></script>
<!-- for debugging: -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.2.3/dojox/image/ThumbnailPicker.js"></script>

<!--  YUI declarations -->

<style type="text/css">
/*margin and padding on body element
  can introduce errors in determining
  element position and are not recommended;
  we turn them off as a foundation for YUI
  CSS treatments. */
body {
   margin:0;
   padding:0;
}
</style>

<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.5.2/build/menu/assets/skins/sam/menu.css" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.5.2/build/button/assets/skins/sam/button.css" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.5.2/build/fonts/fonts-min.css" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.5.2/build/container/assets/skins/sam/container.css" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.5.2/build/autocomplete/assets/skins/sam/autocomplete.css" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.5.2/build/editor/assets/skins/sam/editor.css" />
<link type="text/css" rel="stylesheet" href="http://yui.yahooapis.com/2.5.2/build/logger/assets/skins/sam/logger.css">   

<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/utilities/utilities.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/container/container-min.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/menu/menu-min.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/button/button-min.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/autocomplete/autocomplete-min.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/editor/editor-beta-min.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/yahoo-dom-event/yahoo-dom-event.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/logger/logger-min.js"></script>
<script src="../../src/ubiquity-loader.js" type="text/javascript">/**/</script>
<script type="text/javascript" src="js/ubModelData.js">/**/</script>

<script>
dojo.require("dijit.form.TextBox");
dojo.require("dojo.parser");  // find widgets

// Redirect console output to Dojo console
YAHOO.log = function (msg, cat, app) {
   console.log(msg);
}
</script>

<!--there is no custom header content for this example-->
</head>

<body class="yui-skin-sam">

<!--   
    The XForms Model
    Defining the data for the form, and the submission handling
-->
<xf:model id="picasaWebModel" >
  <!-- The data sent to picasaWeb -->
  <xf:instance id="inst-picasa">
    <instanceData xmlns="">
      <kind>photo</kind>
      <q/>
      <max-results>12</max-results>
    </instanceData>
  </xf:instance>
  <!-- The data received by Picasa -->
  <xf:instance id="inst-rs" xmlns="">
    <dummy/>
  </xf:instance>
  <xf:submission id="sub-picasaWeb" method="get" 
      action="http://picasaweb.google.com/data/feed/api/all"
      separator="&amp;" replace="instance" instance="inst-rs">
  </xf:submission>
</xf:model>



<h1>picasaweb Image Search powered by XForms Data Source</h1>

<div class="exampleIntro">
<p>This example provides a new button (<img src="images/picasaweb_default.gif">) in the toolbar that opens a custom panel.</p>
<p>This custom panel contains an <a href="http://developer.yahoo.com/yui/autocomplete/">YUI AutoComplete Control</a> 
   that queries picasaweb for tags and displays the images on the custom panels and a 
   <a href="http://dojotoolkit.org/book/dojo-book-0-9/part-5-dojox/dojox-image/thumbnailpicker">Dojo ThumbnailPicker</a>
   both widgets are using a single common XForms data source.</p>
<p>A selected image will be inserted into the Editor for ease of use.</p>
        
</div>

<!--BEGIN SOURCE CODE FOR EXAMPLE =============================== -->

<style>
    .yui-skin-sam .yui-toolbar-container .yui-toolbar-picasaweb span.yui-toolbar-icon {
        background-image: url( images/picasaweb_default.gif );
        background-position: 1px 0px;
        left: 5px;
    }
    .yui-skin-sam .yui-toolbar-container .yui-toolbar-picasaweb-selected span.yui-toolbar-icon {
        background-image: url( images/picasaweb_active.gif );
        background-position: 1px 0px;
        left: 5px;
    }

        #gutter1 {
            overflow: hidden;
            visibility: hidden;
            text-align: left;
        }

        #gutter1 .bd {
            border:1px solid #808080;
            border-left: none;
            background-color: #F2F2F2;
            height: 95%;
            overflow: hidden;
            width: 249px;
            margin-top: 10px;
            padding-left: .25em;
        }

        #gutter1 ul {
            list-style-type: none;
        }
        #gutter1 ul li {
            margin: 0;
            padding: 0;
            float:left;
            display:inline;
        }

        #gutter1 .bd h2 {
            font-size: 120%;
            font-weight: bold;
            margin: 0.5em 0;
            color: #000;
            border: none;
        }

        #gutter1 img {
            margin: 0 .5em;
            border:1px solid #808080;
            height: 50px;
            width: 50px;
        }

        #picasaweb_results {
            height: 75%;
            overflow: auto;
            position:static;
        }

        #picasaweb_results p {
            padding: .5em;
            margin-bottom: 1em;
        }

        #picasaweb_results div.yui-ac-content {
            width: 225px;
        }

        .yui-skin-sam .yui-ac-input {
            position: static;
            width: 12em;
        }

        #gutter1 .tip {
            display:block;
            font-size:85%;
            margin:0.5em;
            padding-left:23px;
            position:relative;
            text-align:left;
        }

        #gutter1 .tip span.icon-info {
            background-position:-106px -32px;
            background-image:url(css/sprite.png);
            background-position:-84px -32px;
            display:block;
            height:20px;
            left:0pt;
            position:absolute;
            top:0pt;
            width:20px;
        }
</style>


<h3>Dojo ThumbnailPicker</h3>
This ThumbnailPicker should have 4 thumbnails, with each of them linking
to a URL when clicked on, changing the current page.  The cursor should also change when over an image.
The widget is laid out in the default horizontal layout.
<div id="thumbPicker1" dojoType="dojox.image.ThumbnailPicker" numberThumbs="4" isClickable="true" useHyperlink="new" ></div>

<form method="post" action="#" id="form1">
<textarea id="editor" name="editor" rows="20" cols="75">
This is some more test text. <font face="Times New Roman">This is some more test text. This is some more <b>test <i>text</i></b></font>. This is some more test text. This is some more test text. This is some more test text. This is some more test text. This is some more test text. This is some more test text. 
</textarea>
</form>

<script>

// Setup XForms Data Model Data Source 
 
var modelArgs = {
    id: "picasaWebModel",    // XForms Model id
    submissionId: "sub-picasaWeb", // XForms submission id
    submitDone: {  // XForms listener for submission done
        handleEvent: function(evt) { YAHOO.log("xforms submit OK", 'info', 'example'); }
    }, 
    submitError: { // XForms listener for submission error
        handleEvent: function(evt) { YAHOO.log("xforms submit error"); }
    },

    // Customize attributes
    itemXPathAttrs : { 
        imageUrlThumb: "media:group/media:thumbnail/@url",
        imageUrl: "media:group/media:content/@url",
        link: "media:group/media:content/@url",
        title: "summary"
    },
    
    request : {
        query: {
           param: "instance('inst-picasa')/q",
           result: "instance('inst-rs')/entry" 
        },
        start: 0, //start at record 0
        pageSize: 12 //request 12 records each time a request is made
    }
};

var oACDSModel = new UBXFx.data.ModelData(modelArgs);


/* Gutter Plugin */
(function() {
    var Dom = YAHOO.util.Dom,
        Event = YAHOO.util.Event;

    YAHOO.gutter = function() {
        return {
            status: false,
            gutter: null,
            createGutter: function() {
                YAHOO.log('Creating gutter (#gutter1)', 'info', 'example');
                this.gutter = new YAHOO.widget.Overlay('gutter1', {
                    height: '400px',
                    width: '300px',
                    context: [myEditor.get('element_cont').get('element'), 'tl', 'tr'],
                    position: 'absolute',
                    visible: false
                });
                this.gutter.hideEvent.subscribe(function() {
                    myEditor.toolbar.deselectButton('picasaweb');
                    Dom.setStyle('gutter1', 'visibility', 'visible');                
                    var anim = new YAHOO.util.Anim('gutter1', {
                        width: {
                            from: 300,
                            to: 0
                        },
                        opacity: {
                            from: 1,
                            to: 0
                        }
                    }, 1);
                    anim.onComplete.subscribe(function() {  
                        Dom.setStyle('gutter1', 'visibility', 'hidden');
                    });
                    anim.animate();
                }, this, true);
                this.gutter.showEvent.subscribe(function() {
                    myEditor.toolbar.selectButton('picasaweb');
                    this.gutter.cfg.setProperty('context', [myEditor.get('element_cont').get('element'), 'tl', 'tr']);
                    Dom.setStyle(this.gutter.element, 'width', '0px');
                    var anim = new YAHOO.util.Anim('gutter1', {
                        width: {
                            from: 0,
                            to: 300
                        },
                        opacity: {
                            from: 0,
                            to: 1
                        }
                    }, 1);
                    anim.animate();
                }, this, true);
                var warn = '';
                if (myEditor.browser.webkit || myEditor.browser.opera) {
                    warn = myEditor.STR_IMAGE_COPY;
                }
                this.gutter.setBody('<h2>picasaweb Image Search</h2><label for="flikr_search">Tag:</label><input type="text" value="" id="picasaweb_search"><div id="picasaweb_results"><p>Enter picasaweb tags into the box above, separated by commas. Be patient, this example my take a few seconds to get the images..</p></div>' + warn);
                this.gutter.render(document.body);
            },
            open: function() {
                Dom.get('picasaweb_search').value = '';
                YAHOO.log('Show Gutter', 'info', 'example');
                this.gutter.show();
                this.status = true;
            },
            close: function() {
                YAHOO.log('Close Gutter', 'info', 'example');
                this.gutter.hide();
                this.status = false;
            },
            toggle: function() {
                if (this.status) {
                    this.close();
                } else {
                    this.open();
                }
            }
        }
    }
    
})();



YAHOO.util.Event.onAvailable('picasaweb_search', function() {
    YAHOO.log('onAvailable: #picasaweb_search', 'info', 'example');
    YAHOO.util.Event.on('picasaweb_results', 'mousedown', function(ev) {
        YAHOO.util.Event.stopEvent(ev);
        var tar = YAHOO.util.Event.getTarget(ev);
        if (tar.tagName.toLowerCase() == 'img') {
            if (tar.getAttribute('fullimage', 2)) {
                YAHOO.log('Found an image, insert it..', 'info', 'example');
                var img = tar.getAttribute('fullimage', 2),
                    title = tar.getAttribute('fulltitle'),
                    owner = tar.getAttribute('fullowner'),
                    url = tar.getAttribute('fullurl');
                this.toolbar.fireEvent('picasawebClick', { type: 'picasawebClick', img: img, title: title, owner: owner, url: url });
            }
        }
    }, myEditor, true);

    // change listener on submitDone and set the DataSource to Dojo thumbnail widget 
    oACDSModel.onSubmitDone = { 
        handleEvent: function(evt) {
            dijit.byId('thumbPicker1').setDataStore(oACDSModel, modelArgs.request, null); 
        } 
    };
    
    // Instantiate AutoComplete
    oAutoComp = new YAHOO.widget.AutoComplete('picasaweb_search','picasaweb_results', oACDSModel);
    oAutoComp.autoHighlight = false;
    oAutoComp.alwaysShowContainer = true; 
    oAutoComp.maxResultsDisplayed = 12;
    oAutoComp.formatResult = function(oResult, sQuery) {
        var oResultItem = oResult[1]; 
        YAHOO.log('format result1 ' + oResultItem.toString(), 'info', 'example'); 
        // This was defined by the schema array of the data source
        var sTitle = oResultItem.getValue("title");
        var sOwner = oResultItem.getValue("owner");
        var sUrl = oResultItem.getValue("imageUrlThumb");
        var lUrl = oResultItem.getValue("imageUrl");
        var fUrl = oResultItem.getValue("link");
        var sMarkup = '<img src="' + sUrl + '" fullimage="' + lUrl + '" fulltitle="' + sTitle + '" fullid="' + sOwner + '" fullurl="' + fUrl + '" class="yui-ac-picasawebImg" title="Click to add this image to the editor"><br>';
        return (sMarkup);
    };
});

var gutter = null;

var myConfig = {
    height: '300px',
    width: '530px',
    animate: true,
    dompath: true,
    focusAtStart: true
};

YAHOO.log('Editor loaded..', 'info', 'example');
var myEditor = new YAHOO.widget.Editor('editor', myConfig);

myEditor.on('toolbarLoaded', function() { 
    YAHOO.log('Toolbar loaded, add button and create gutter', 'info', 'example');
    gutter = new YAHOO.gutter();

    var picasawebConfig = {
            type: 'push',
            label: 'Insert picasaweb Image',
            value: 'picasaweb'
    }
   
    myEditor.toolbar.addButtonToGroup(picasawebConfig, 'insertitem');

    myEditor.toolbar.on('picasawebClick', function(ev) {
        YAHOO.log('picasawebClick: ' + YAHOO.lang.dump(ev), 'info', 'example');
        this._focusWindow();
        if (ev && ev.img) {
            YAHOO.log('We have an image, insert it', 'info', 'example');
            //To abide by the picasaweb TOS, we need to link back to the image that we just inserted
            var html = '<a href="' + ev.url + '"><img src="' + ev.img + '" title="' + ev.title + '"></a>';
            this.execCommand('inserthtml', html);
        }
        gutter.toggle();
    }, myEditor, true);
    gutter.createGutter();
});
myEditor.render();

</script>

<!--END SOURCE CODE FOR EXAMPLE =============================== -->

<!--MyBlogLog instrumentation-->
<script type="text/javascript" src="http://track2.mybloglog.com/js/jsserv.php?mblID=2007020704011645"></script> 
</body>
</html>
